<html>
<head>
  <title>Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    h2 { margin-top: 40px; }
    .user-pick { margin: 10px 0; }
    input[type="number"] { width: 60px; }
  </style>
</head>
<body>
  <h1>Admin: Assign Points</h1>
  <label for="stage">Stage Date (YYYY-MM-DD): </label>
  <select id="stage"></select>
  <button onclick="loadPicks()">Load Picks</button>

  <div id="picks-section"></div>

  <script>

async function loadStageOptions() {
  const snapshot = await db.collection("stages").get();
  const stageSelect = document.getElementById("stage");
  snapshot.docs.forEach(doc => {
    const option = document.createElement("option");
    option.value = doc.id;
    option.textContent = doc.id;
    stageSelect.appendChild(option);
  });
}
    
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Optional: restrict access only to admin user
    const ADMIN_EMAIL = "diogo.momteiro@gmail.com";

    auth.onAuthStateChanged(user => {
      if (!user || user.email !== ADMIN_EMAIL) {
        alert("Access Denied");
        window.location.href = "index.html";
      }
    });

    async function loadPicks() {
      const date = document.getElementById("stage").value;
      const container = document.getElementById("picks-section");
      container.innerHTML = "";

      const snapshot = await db.collection("picks").doc(date).collection("users").get();

      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.classList.add("user-pick");
        div.innerHTML = `
          <strong>${data.name}</strong> â€“ picked <em>${data.cyclist}</em>
          | Points: <input type="number" value="${data.points || 0}" id="points-${doc.id}" />
          <button onclick="savePoints('${date}', '${doc.id}')">Save</button>
        `;
        container.appendChild(div);
      });
    }

    async function savePoints(date, userId) {
      const points = parseInt(document.getElementById(`points-${userId}`).value);
      await db.collection("picks").doc(date).collection("users").doc(userId).update({ points });
      alert("Points saved for user " + userId);
    }

    auth.onAuthStateChanged(user => {
  if (!user || user.email !== ADMIN_EMAIL) {
    alert("Access Denied");
    window.location.href = "index.html";
  } else {
    loadStageOptions();
  }
});
    
  </script>
</body>
</html>
